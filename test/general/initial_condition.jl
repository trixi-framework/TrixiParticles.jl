# 2D
@testset "Merge InitialConditions 2D" begin
    @testset "Rectangular Shapes" begin
        shape_1 = RectangularShape(0.1, (3, 4), (-1.05, 0.95), 1.0)
        shape_2 = RectangularShape(0.05, (3, 4), (-0.025, 0.975), 1.0)
        shape_3 = RectangularShape(0.2, (3, 4), (-0.1, -0.1), 1.0)

        expected_coords_1 = [-1.0 -1.0 -1.0 -1.0 -0.9 -0.9 -0.9 -0.9 -0.8 -0.8 -0.8 -0.8 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1;
                             1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15]
        expected_coords_2 = [-1.0 -1.0 -1.0 -1.0 -0.9 -0.9 -0.9 -0.9 -0.8 -0.8 -0.8 -0.8 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.0 0.0 0.0 0.0 0.2 0.2 0.2 0.2 0.4 0.4 0.4 0.4;
                             1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15 0.0 0.2 0.4 0.6 0.0 0.2 0.4 0.6 0.0 0.2 0.4 0.6]
        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords_1

        initial_condition = InitialCondition(shape_1, shape_2, shape_3)
        @test initial_condition.coordinates ≈ expected_coords_2
    end

    @testset "Sphere Shapes" begin
        shape_1 = SphereShape(0.1, 0.5, (-1.0, 1.0), 1.0)
        shape_2 = SphereShape(0.05, 0.2, (0.0, 1.0), 1.0)
        shape_3 = SphereShape(0.15, 1.0, (0.0, -0.2), 1.0)

        expected_coords_1 = [-1.2 -1.1 -1.0 -0.9 -0.8 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.2 -1.1 -1.0 -0.9 -0.8 -0.05 0.0 0.05 -0.1 -0.05 0.0 0.05 0.1 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.1 -0.05 0.0 0.05 0.1 -0.05 0.0 0.05;
                             0.6 0.6 0.6 0.6 0.6 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.4 1.4 1.4 1.4 1.4 0.85 0.85 0.85 0.9 0.9 0.9 0.9 0.9 0.95 0.95 0.95 0.95 0.95 0.95 0.95 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.05 1.05 1.05 1.05 1.05 1.05 1.05 1.1 1.1 1.1 1.1 1.1 1.15 1.15 1.15]

        expected_coords_2 = [-1.2 -1.1 -1.0 -0.9 -0.8 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.2 -1.1 -1.0 -0.9 -0.8 -0.05 0.0 0.05 -0.1 -0.05 0.0 0.05 0.1 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.1 -0.05 0.0 0.05 0.1 -0.05 0.0 0.05 -0.15 0.0 0.15 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 -0.9 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 0.9 -0.9 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 0.9 -0.9 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 0.9 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 -0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 0.75 -0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 0.6 -0.45 -0.3 -0.15 0.0 0.15 0.3 0.45 -0.15 0.0 0.15;
                             0.6 0.6 0.6 0.6 0.6 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.4 1.4 1.4 1.4 1.4 0.85 0.85 0.85 0.9 0.9 0.9 0.9 0.9 0.95 0.95 0.95 0.95 0.95 0.95 0.95 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.05 1.05 1.05 1.05 1.05 1.05 1.05 1.1 1.1 1.1 1.1 1.1 1.15 1.15 1.15 -1.1 -1.1 -1.1 -0.95 -0.95 -0.95 -0.95 -0.95 -0.95 -0.95 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.65 -0.65 -0.65 -0.65 -0.65 -0.65 -0.65 -0.65 -0.65 -0.65 -0.65 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 -0.05 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.25 0.25 0.25 0.25 0.25 0.25 0.25 0.25 0.25 0.25 0.25 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.55 0.55 0.55 0.55 0.55 0.55 0.55 0.7 0.7 0.7]

        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords_1

        initial_condition = InitialCondition(shape_1, shape_2, shape_3)
        @test initial_condition.coordinates ≈ expected_coords_2
    end

    @testset "Mixed Shapes" begin
        shape_1 = SphereShape(0.1, 0.8, (0.0, 1.0), 1.0, sphere_type=RoundSphere())
        shape_2 = RectangularShape(0.05, (3, 4), (-0.5, 0.0), 1.0)

        expected_coords = [0.05 -0.025 -0.025 0.15 0.11490667 0.02604723 -0.075 -0.14095389 -0.14095389 -0.075 0.02604723 0.11490667 0.25 0.23096988 0.1767767 0.09567086 0.0 -0.09567086 -0.1767767 -0.23096988 -0.25 -0.23096988 -0.1767767 -0.09567086 -0.0 0.09567086 0.1767767 0.23096988 0.35 0.33582254 0.29443874 0.22920126 0.14539525 0.04981019 -0.04981019 -0.14539525 -0.22920126 -0.29443874 -0.33582254 -0.35 -0.33582254 -0.29443874 -0.22920126 -0.14539525 -0.04981019 0.04981019 0.14539525 0.22920126 0.29443874 0.33582254 0.45 0.43871756 0.40543599 0.35182417 0.28057041 0.19524768 0.10013442 0.0 -0.10013442 -0.19524768 -0.28057041 -0.35182417 -0.40543599 -0.43871756 -0.45 -0.43871756 -0.40543599 -0.35182417 -0.28057041 -0.19524768 -0.10013442 -0.0 0.10013442 0.19524768 0.28057041 0.35182417 0.40543599 0.43871756 0.55 0.54116127 0.51492918 0.47214684 0.41418931 0.34291939 0.26062776 0.16995935 0.0738283 -0.02467566 -0.12238651 -0.21616377 -0.30299334 -0.38008446 -0.44495935 -0.49553288 -0.53017957 -0.54778586 -0.54778586 -0.53017957 -0.49553288 -0.44495935 -0.38008446 -0.30299334 -0.21616377 -0.12238651 -0.02467566 0.0738283 0.16995935 0.26062776 0.34291939 0.41418931 0.47214684 0.51492918 0.54116127 0.65 0.64238228 0.61970765 0.58250761 0.53165408 0.46833904 0.39404652 0.31051788 0.21971097 0.12375422 0.02489678 -0.07454423 -0.17223798 -0.26589461 -0.35331891 -0.43246171 -0.50146797 -0.55872024 -0.60287659 -0.63290203 -0.64809277 -0.64809277 -0.63290203 -0.60287659 -0.55872024 -0.50146797 -0.43246171 -0.35331891 -0.26589461 -0.17223798 -0.07454423 0.02489678 0.12375422 0.21971097 0.31051788 0.39404652 0.46833904 0.53165408 0.58250761 0.61970765 0.64238228 0.75 0.74330812 0.72335188 0.69048742 0.64530118 0.58859954 0.52139432 0.44488481 0.36043632 0.26955583 0.17386511 0.07507177 -0.02506123 -0.12474702 -0.22220669 -0.31570107 -0.40356176 -0.48422089 -0.55623908 -0.61833117 -0.66938913 -0.70850182 -0.73497128 -0.74832516 -0.74832516 -0.73497128 -0.70850182 -0.66938913 -0.61833117 -0.55623908 -0.48422089 -0.40356176 -0.31570107 -0.22220669 -0.12474702 -0.02506123 0.07507177 0.17386511 0.26955583 0.36043632 0.44488481 0.52139432 0.58859954 0.64530118 0.69048742 0.72335188 0.74330812 -0.475 -0.475 -0.475 -0.475 -0.425 -0.425 -0.425 -0.425 -0.375 -0.375 -0.375 -0.375;
                           1.0 1.04330127 0.95669873 1.0 1.09641814 1.14772116 1.12990381 1.05130302 0.94869698 0.87009619 0.85227884 0.90358186 1.0 1.09567086 1.1767767 1.23096988 1.25 1.23096988 1.1767767 1.09567086 1.0 0.90432914 0.8232233 0.76903012 0.75 0.76903012 0.8232233 0.90432914 1.0 1.09860639 1.18922429 1.26451235 1.3183712 1.3464375 1.3464375 1.3183712 1.26451235 1.18922429 1.09860639 1.0 0.90139361 0.81077571 0.73548765 0.6816288 0.6535625 0.6535625 0.6816288 0.73548765 0.81077571 0.90139361 1.0 1.10013442 1.19524768 1.28057041 1.35182417 1.40543599 1.43871756 1.45 1.43871756 1.40543599 1.35182417 1.28057041 1.19524768 1.10013442 1.0 0.89986558 0.80475232 0.71942959 0.64817583 0.59456401 0.56128244 0.55 0.56128244 0.59456401 0.64817583 0.71942959 0.80475232 0.89986558 1.0 1.09820629 1.19325615 1.2820946 1.3618663 1.43000732 1.48432754 1.52308108 1.54502237 1.54944619 1.53621035 1.50574027 1.45901529 1.39753718 1.32328189 1.23863606 1.14632027 1.04930162 0.95069838 0.85367973 0.76136394 0.67671811 0.60246282 0.54098471 0.49425973 0.46378965 0.45055381 0.45497763 0.47691892 0.51567246 0.56999268 0.6381337 0.7179054 0.80674385 0.90179371 1.0 1.09922203 1.19611839 1.28841789 1.37395713 1.45073113 1.51694037 1.57103296 1.61174103 1.63811041 1.64952302 1.64571136 1.62676477 1.59312735 1.54558753 1.48525959 1.41355759 1.33216214 1.2429811 1.14810478 1.04975701 0.95024299 0.85189522 0.7570189 0.66783786 0.58644241 0.51474041 0.45441247 0.40687265 0.37323523 0.35428864 0.35047698 0.36188959 0.38825897 0.42896704 0.48305963 0.54926887 0.62604287 0.71158211 0.80388161 0.90077797 1.0 1.09996522 1.19814655 1.29279196 1.38221248 1.46481242 1.53911776 1.60380254 1.65771245 1.69988546 1.729569 1.74623336 1.74958117 1.73955269 1.71632687 1.68031819 1.6321692 1.57273915 1.50308855 1.42446032 1.33825759 1.24601864 1.14938949 1.05009448 0.94990552 0.85061051 0.75398136 0.66174241 0.57553968 0.49691145 0.42726085 0.3678308 0.31968181 0.28367313 0.26044731 0.25041883 0.25376664 0.270431 0.30011454 0.34228755 0.39619746 0.46088224 0.53518758 0.61778752 0.70720804 0.80185345 0.90003478 0.025 0.075 0.125 0.175 0.025 0.075 0.125 0.175 0.025 0.075 0.125 0.175]

        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords
    end
end

# 3D
@testset "Merge InitialConditions 3D" begin
    @testset "Rectangular Shapes" begin
        shape_1 = RectangularShape(0.1, (3, 4, 2), (-1.05, 0.95, 0.05), 1.0)
        shape_2 = RectangularShape(0.05, (3, 4, 5), (-0.525, -0.025, -0.225), 1.0)

        expected_coords = [-1.0 -1.0 -1.0 -1.0 -1.0 -1.0 -1.0 -1.0 -0.9 -0.9 -0.9 -0.9 -0.9 -0.9 -0.9 -0.9 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4;
                           1.0 1.0 1.1 1.1 1.2 1.2 1.3 1.3 1.0 1.0 1.1 1.1 1.2 1.2 1.3 1.3 1.0 1.0 1.1 1.1 1.2 1.2 1.3 1.3 0.0 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.1 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.0 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.1 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.0 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.1 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002;
                           0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0]

        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords
    end
end
