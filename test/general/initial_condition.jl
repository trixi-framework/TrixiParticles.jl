# 2D
@testset "Merge InitialConditions 2D" begin
    @testset "Rectangular Shapes" begin
        shape_1 = RectangularShape(0.1, (3, 4), (-1.0, 1.0), 1.0)
        shape_2 = RectangularShape(0.05, (3, 4), (0.0, 1.0), 1.0)
        shape_3 = RectangularShape(0.2, (3, 4), (0.0, 0.0), 1.0)

        expected_coords_1 = [-1.0 -1.0 -1.0 -1.0 -0.9 -0.9 -0.9 -0.9 -0.8 -0.8 -0.8 -0.8 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1;
                             1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15]
        expected_coords_2 = [-1.0 -1.0 -1.0 -1.0 -0.9 -0.9 -0.9 -0.9 -0.8 -0.8 -0.8 -0.8 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.0 0.0 0.0 0.0 0.2 0.2 0.2 0.2 0.4 0.4 0.4 0.4;
                             1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.1 1.2 1.3 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15 1.0 1.05 1.1 1.15 0.0 0.2 0.4 0.6 0.0 0.2 0.4 0.6 0.0 0.2 0.4 0.6]
        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords_1

        initial_condition = InitialCondition(shape_1, shape_2, shape_3)
        @test initial_condition.coordinates ≈ expected_coords_2
    end

    @testset "Circular Shapes" begin
        shape_1 = CircularShape(0.1, 0.5, (-1.0, 1.0), 1.0)
        shape_2 = CircularShape(0.05, 0.2, (0.0, 1.0), 1.0)
        shape_3 = CircularShape(0.15, 1.0, (0.0, -0.2), 1.0)

        expected_coords_1 = [-1.2 -1.1 -1.0 -0.9 -0.8 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 0.0 -0.1 -0.05 0.0 0.05 0.1 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.15 -0.1 -0.05 0.0 0.05 0.1 0.15 -0.1 -0.05 0.0 0.05 0.1 0.0;
                             0.6 0.6 0.6 0.6 0.6 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.4 1.4 1.4 1.4 1.4 1.4 1.4 0.8 0.85 0.85 0.85 0.85 0.85 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.95 0.95 0.95 0.95 0.95 0.95 0.95 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.05 1.05 1.05 1.05 1.05 1.05 1.05 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.15 1.15 1.15 1.15 1.15 1.2]

        expected_coords_2 = [-1.2 -1.1 -1.0 -0.9 -0.8 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -0.6 -1.4 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 -1.3 -1.2 -1.1 -1.0 -0.9 -0.8 -0.7 0.0 -0.1 -0.05 0.0 0.05 0.1 -0.15000000000000002 -0.1 -0.05 0.0 0.05 0.1 0.15000000000000002 -0.15000000000000002 -0.1 -0.05 0.0 0.05 0.1 0.15000000000000002 -0.15000000000000002 -0.1 -0.05 0.0 0.05 0.1 0.15000000000000002 -0.15000000000000002 -0.1 -0.05 0.0 0.05 0.1 0.15000000000000002 -0.15000000000000002 -0.1 -0.05 0.0 0.05 0.1 0.15000000000000002 -0.1 -0.05 0.0 0.05 0.1 0.0 -0.3 -0.15 0.0 0.15 0.3 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 -0.8999999999999999 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 0.8999999999999999 -0.8999999999999999 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 0.8999999999999999 -0.8999999999999999 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 0.8999999999999999 -0.8999999999999999 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 0.8999999999999999 -0.8999999999999999 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 0.8999999999999999 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 -0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 0.75 -0.6 -0.44999999999999996 -0.3 -0.15 0.0 0.15 0.3 0.44999999999999996 0.6 -0.3 -0.15 0.0 0.15 0.3;
                             0.6 0.6 0.6 0.6 0.6 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.4 1.4 1.4 1.4 1.4 1.4 1.4 0.8 0.85 0.85 0.85 0.85 0.85 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.95 0.95 0.95 0.95 0.95 0.95 0.95 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.05 1.05 1.05 1.05 1.05 1.05 1.05 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.15 1.15 1.15 1.15 1.15 1.2 -1.0999999999999999 -1.0999999999999999 -1.0999999999999999 -1.0999999999999999 -1.0999999999999999 -0.95 -0.95 -0.95 -0.95 -0.95 -0.95 -0.95 -0.95 -0.95 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.6499999999999999 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.35 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.2 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 -0.05000000000000002 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.09999999999999998 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.24999999999999994 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.39999999999999997 0.55 0.55 0.55 0.55 0.55 0.55 0.55 0.55 0.55 0.7 0.7 0.7 0.7 0.7]

        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords_1

        initial_condition = InitialCondition(shape_1, shape_2, shape_3)
        @test initial_condition.coordinates ≈ expected_coords_2
    end

    @testset "Mixed Shapes" begin
        shape_1 = CircularShape(0.1, 0.8, (0.0, 1.0), 1.0)
        shape_2 = RectangularShape(0.05, (3, 4), (-0.5, 0.0), 1.0)

        expected_coords = [-0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 0.7000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 -0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 0.6000000000000001 -0.5 -0.4 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 0.4 0.5 -0.30000000000000004 -0.2 -0.1 0.0 0.1 0.2 0.30000000000000004 -0.5 -0.5 -0.5 -0.5 -0.45 -0.45 -0.45 -0.45 -0.4 -0.4 -0.4 -0.4;
                           0.29999999999999993 0.29999999999999993 0.29999999999999993 0.29999999999999993 0.29999999999999993 0.29999999999999993 0.29999999999999993 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.3999999999999999 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.6 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.7 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.8 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.1 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.2 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.4 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.5 1.6 1.6 1.6 1.6 1.6 1.6 1.6 1.6 1.6 1.6 1.6 1.7000000000000002 1.7000000000000002 1.7000000000000002 1.7000000000000002 1.7000000000000002 1.7000000000000002 1.7000000000000002 0.0 0.05 0.1 0.15000000000000002 0.0 0.05 0.1 0.15000000000000002 0.0 0.05 0.1 0.15000000000000002]

        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords
    end
end

# 3D
@testset "Merge InitialConditions 3D" begin
    @testset "Rectangular Shapes" begin
        shape_1 = RectangularShape(0.1, (3, 4, 2), (-1.0, 1.0, 0.1), 1.0)
        shape_2 = RectangularShape(0.05, (3, 4, 5), (-0.5, 0.0, -0.2), 1.0)

        expected_coords = [-1.0 -1.0 -1.0 -1.0 -1.0 -1.0 -1.0 -1.0 -0.9 -0.9 -0.9 -0.9 -0.9 -0.9 -0.9 -0.9 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.8 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.5 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.45 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4 -0.4;
                           1.0 1.0 1.1 1.1 1.2 1.2 1.3 1.3 1.0 1.0 1.1 1.1 1.2 1.2 1.3 1.3 1.0 1.0 1.1 1.1 1.2 1.2 1.3 1.3 0.0 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.1 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.0 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.1 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.0 0.0 0.0 0.0 0.0 0.05 0.05 0.05 0.05 0.05 0.1 0.1 0.1 0.1 0.1 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002 0.15000000000000002;
                           0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 0.1 0.2 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0 -0.2 -0.15000000000000002 -0.1 -0.04999999999999999 0.0]

        initial_condition = InitialCondition(shape_1, shape_2)
        @test initial_condition.coordinates ≈ expected_coords
    end
end

@testset "System Buffer" begin
    buffer_particles = 5

    shape_1 = RectangularShape(0.1, (3, 6), (0.0, 0.0), 1.0)
    shape_2 = RectangularShape(0.1, (3, 6), (0.0, 0.0), 1.0, buffer=buffer_particles)
    shape_3 = RectangularShape(0.1, (4, 5), (0.0, 0.0), 1.0)

    initial_condition = InitialCondition(shape_1, shape_3, buffer=buffer_particles)

    @test size(shape_1.coordinates) == (2, 18)
    @test size(shape_2.coordinates) == (2, 18 + buffer_particles)
    @test size(shape_2.velocity) == (2, 18 + buffer_particles)
    @test size(shape_2.mass) == (18 + buffer_particles,)
    @test size(shape_2.density) == (18 + buffer_particles,)

    @test size(initial_condition.coordinates) == (2, 38 + buffer_particles)
    @test size(initial_condition.velocity) == (2, 38 + buffer_particles)
    @test size(initial_condition.mass) == (38 + buffer_particles,)
    @test size(initial_condition.density) == (38 + buffer_particles,)

    @test shape_1.buffer == nothing
    @test shape_2.buffer isa TrixiParticles.SystemBuffer
    @test initial_condition.buffer isa TrixiParticles.SystemBuffer

    error_str = "You have passed `buffer` before. Please pass `buffer` only here."
    @test_throws ArgumentError(error_str) InitialCondition(shape_1, shape_2)

    error_str = "invalid buffer: 1.0 of type Float64"
    @test_throws ArgumentError(error_str) RectangularShape(0.1, (2, 2), (0, 0), 1.0,
                                                           buffer=1.0)
end
